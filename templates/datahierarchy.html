<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel = "stylesheet" href = "{{url_for('static', filename='/css/datahierarchy.css')}}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}">
        <style>
            .error {
              color: red;
            }
        </style>
        {% include 'navbar.html' %}
    </head>
    <body>
        <div class="container">
            <h2>Data Hierarchy</h2>
            <div id="subjectNames" hidden>{{ subjectNames }}</div>
            <div id="subjectDescriptions" hidden>{{ subjectDescriptions }}</div>
            <table id="datasTable">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>DOE - Mechanical Science</td>
                        <td>Description here</td>
                    </tr>
                    <tr>
                        <td>DOE - Electrical Science</td>
                        <td>Description here</td>
                    </tr>
                    <tr>
                        <td>Fish Ladders</td>
                        <td>Covers fish ladders, fish flow theory, and operation of fish facilities</td>
                    </tr>
                    <tr>
                        <td>Bulk Electric System</td>
                        <td>Description here</td>
                    </tr>
                    <tr>
                        <td>Subject</td>
                        <td>Description here</td>
                    </tr>
                </tbody>
            </table>
            <!-- Buttons -->
            <button onclick="viewAllDatas()">View Topics</button>
            <button onclick="addData()">Add</button>
            <button onclick="editData()">Edit</button>
            <button onclick="deleteData()">Delete</button>
            <!-- JS -->
            <script>
                // Sample data for demonstration
                /*
                let data = [
                    { data: 'DOE - Mechanical Science', description: 'Description here' },
                    {data: 'DOE - Electrical Science', description: 'Description here' },
                    { data: 'Fish Ladders', description: 'Covers fish ladders, fish flow theory, and operation of fish facilities' },
                    { data: 'Bulk Electric System', description: 'Description here' },
                    { data: 'Subject', description: 'Description here' },
                    { data: 'Subject', description: 'Description here' },
                ];
                */
                let data = [];

                let sNames = document.getElementById("subjectNames").innerHTML;
                let sDescriptions = document.getElementById("subjectDescriptions").innerHTML;

                sNames = filterFlask(sNames);
                sDescriptions = filterFlask(sDescriptions);

                for(let i=0;i<sNames.length;i++)
                {
                    let tempData = {data:sNames[i],description:sDescriptions[i]};
                    data.push(tempData);
                }

                viewAllDatas();

                function xhrSend(type,value1,value2)
                {
                    let xhr = new XMLHttpRequest();

                    let json = JSON.stringify({
                      type: type,
                      value1: value1,
                        value2: value2
                    });

                    xhr.open("POST", '/datahierarchy')
                    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');

                    xhr.send(json);

                    xhr.onload = function(event)
                    {
                        if(json.type === "add") {
                            data.push({data: json.value1, description: json.value2});
                            viewAllDatas();
                        }
                        let res = event.target.response;
                        console.log(res);

                    }
                }

                //function takes all the junk that gets inserted into the data from flask, probably breaks under
                //specific character sequences, also it removes all apostrophes and single quotes
                function filterFlask(str)
                {
                    str = str.replaceAll("[","");
                    str = str.replaceAll("]","");
                    str = str.split(",),");
                    str[0] = " "+str[0];
                    for(let i=0;i<str.length;i++)
                    {
                        str[i] = str[i].replace(" (","");
                        str[i] = str[i].replaceAll("\'","");
                    }
                    str[str.length-1] = str[str.length-1].replace(",)","");

                    return str;
                }

                // Function to view topics that are part of the data theme *work in progress
                function viewAllDatas() {
                    const tableBody = document.getElementById('datasTable').getElementsByTagName('tbody')[0];
                    clearTable(tableBody);

                    data.forEach(data => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).innerText = data.data;
                        row.insertCell(1).innerText = data.description;
                    });
                }

                // Function to add data entries
                function addData() {
                    const newData = prompt('Enter the new data:');
                    const newDescription = prompt('Enter the description for the new data:');

                    /*
                    if (newData && newDescription) {
                        data.push({ data: newData, description: newDescription });
                        viewAllDatas();
                    }
                     */

                    xhrSend("add",""+newData,""+newDescription);
                }

                // Function to edit data entries
                function editData() {
                    const rowIndex = prompt('Enter the row index to edit:');
                    const dataToEdit = data[rowIndex];

                    if (dataToEdit) {
                        const updatedData = prompt('Enter the updated data:', dataToEdit.data);
                        const updatedDescription = prompt('Enter the updated description:', dataToEdit.description);

                        if (updatedData !== null && updatedDescription !== null) {
                            dataToEdit.data = updatedData;
                            dataToEdit.description = updatedDescription;
                            viewAllDatas(); // Refresh the table after editing
                        }
                    }
                }

                // Function to delete data
                function deleteData() {
                    const rowIndex = prompt('Enter the row index to delete:');
                    
                    if (rowIndex !== null && rowIndex >= 0 && rowIndex < data.length) {
                        data.splice(rowIndex, 1);
                        viewAllDatas();
                    }
                    xhrSend("delete",""+rowIndex,"");
                }

                // Function to clear table
                function clearTable(tableBody) {
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                }
            </script>
        </div>
    </body>
</html>