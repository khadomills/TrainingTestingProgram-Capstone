<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel = "stylesheet" href = "{{url_for('static', filename='/css/datahierarchy.css')}}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}">
        <style>
            .error {
              color: red;
            }
        </style>
        {% include 'navbar.html' %}
    </head>
    <body>
        <div class="container">
            <h2>Data Hierarchy</h2>
            <table class="gridview" id="datasTable">
                <thead>
                    <tr>
                        <th>Subject ID</th>
                        <th>Subject</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subject in subjects %}
                        <tr onclick="toggleClass(this, 'selected');">
                            <td>{{ subject.subject_id | string}}</td>
                            <td>{{ subject.name | string}}</td>
                            <td>{{ subject.description | string}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- Buttons -->
            <button onclick="viewTopics()">View Topics</button>
            <button onclick="addData()">Add</button>
            <button onclick="editData()">Edit</button>
            <button onclick="deleteData()">Delete</button>
            <!-- JS -->
            <script>
                let data = [];

                function toggleClass(el, className) {
                    var rows = el.parentNode.getElementsByTagName("tr");

                    for (var i = 0; i < rows.length; i++){
                        // Remove class from all other rows that aren't selected
                        if(rows[i] !== el){
                            rows[i].classList.remove(className);
                        }
                    }
                    //Toggle the class of selected row
                    if(el.classList.contains(className)){
                        // If class is selected, remove
                        el.classList.remove(className);
                    }else{
                        // if not selected, select
                        el.classList.add(className);
                    }
                }

                function viewTopics() {
                    // Get all the table rows
                    var rows = document.querySelectorAll('tbody tr');

                    // Initialize a variable to store the selected subject_id
                    var selectedSubjectId = null;

                    // Iterate over each row to find the selected one
                    rows.forEach(function(row) {
                        // Check if the row has the 'selected' class
                        if (row.classList.contains('selected')) {
                            // Get the first cell (subject_id cell) content
                            selectedSubjectId = row.cells[0].textContent;
                        }
                    });

                    // Check if a subject is selected
                    if (selectedSubjectId) {
                        window.location.href = '/datatopichierarchy?subject_id=' + selectedSubjectId;
                    } else {
                        alert('Please select a subject')
                    }
                }

                function xhrSend(type,value1,value2,value3)
                {
                    let xhr = new XMLHttpRequest();

                    let json = JSON.stringify({
                      type: type,
                      value1: value1,
                        value2: value2,
                        value3:value3
                    });

                    xhr.open("POST", '/datahierarchy')
                    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');

                    xhr.send(json);

                    xhr.onload = function(event)
                    {
                       window.location.reload();
                    }
                }


                // Function to add data entries
                function addData() {
                    const newData = prompt('Enter the new data:');
                    const newDescription = prompt('Enter the description for the new data:');

                    xhrSend("add",""+newData,""+newDescription,"");
                }

                // Function to edit data entries
                 function editData() {
                    const rowIndex = prompt('Enter the Subject ID to edit:');

                    const uSubject = prompt('Enter the updated data:');
                    const uDescription = prompt('Enter the updated description:');

                    xhrSend("edit",""+rowIndex,""+uSubject,""+uDescription);


                }

                // Function to delete data
                function deleteData() {
                    const rowIndex = prompt('Enter the row index to delete:');

                    xhrSend("delete",""+rowIndex,"","");
                }

                // Function to clear table
                function clearTable(tableBody) {
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                }
            </script>
        </div>
    </body>
</html>